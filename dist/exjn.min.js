/**
 * @license
 * Copyright (c) 2015 Ninh Pham <nfam.dev@gmail.com>
 *
 * Use of this source code is governed by The MIT license.
 */
var __extends=this&&this.__extends||function(){var extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])};return function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}();!function(factory){if("object"==typeof module&&"object"==typeof module.exports){var v=factory(require,exports);void 0!==v&&(module.exports=v)}else"function"==typeof define&&define.amd&&define(["require","exports"],factory)}(function(require,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var ExpressionError=function(_super){function ExpressionError(message,json){var _this=_super.call(this,message)||this;return _this.json=json,_this}return __extends(ExpressionError,_super),ExpressionError}(Error);exports.ExpressionError=ExpressionError;var ExtractionError=function(_super){function ExtractionError(at){var _this=_super.call(this,"Provided input does not match the expression at ")||this;return _this.at=at,_this}return __extends(ExtractionError,_super),ExtractionError}(Error);function isError(result){return result instanceof Error}exports.ExtractionError=ExtractionError;var messages={arrayType:'Property "array" must be an object.',containsType:'Property "contains" must be a string.',dictionaryType:'Property "dictionary" must be an object.',dictionaryValueType:'Property "{name}" of dictionary must be an object.',elementType:'Property "element" must be an object.',expressionType:"Expression must be an object.",prefixType:'Property "prefix" must be either a string or an array of strings.',processType:'Property "process" must be a string, an object, an array of string or object.',processNameMissing:'Property "name" of process object is missing.',processNameType:'Property "name" of process object must be a string.',processUndefined:'Process "{name}" is not defined as a function.',requiredType:'Property "required" must be boolean or a non-empty string.',reversedType:'Property "reversed" must be boolean.',separatorMissing:'Property "separator" is missing.',separatorType:'Property "separator" must be either a non-empty string or an array of non-empty strings.',subexpressions:"Only one of array, dictionary, or element shall be defined.",suffixType:'Property "suffix" must be either a string or an array of strings.',trimmingType:'Property "trimming" must be boolean.',withinType:'Property "within" must be an object.'},Expression=function(){function Expression(json,processors){if("object"!=typeof json||json instanceof Array)throw new ExpressionError(messages.expressionType,json);processors=processors||{},this.expression=new ElementExpression({element:json},processors,!0)}return Expression.prototype.extract=function(input){var result=this.expression.extract(input);if(isError(result))throw result.message+=result.at+".",result;return function avoidMemoryLeak(item){if("string"==typeof item)item=(" "+item).substring(1);else if("object"==typeof item)if(item instanceof Array)for(var i=0;i<item.length;i+=1)item[i]=avoidMemoryLeak(item[i]);else Object.keys(item).forEach(function(key){item[key]=avoidMemoryLeak(item[key])});return item}(result)},Expression.prototype.toJSON=function(){return this.expression.toJSON()},Expression}();function getSubexpression(json,processors){if(json.hasOwnProperty("element")){if(json.hasOwnProperty("array")||json.hasOwnProperty("dictionary"))throw new ExpressionError(messages.subexpressions,json);return new ElementExpression(json,processors)}if(json.hasOwnProperty("array")){if(json.hasOwnProperty("dictionary"))throw new ExpressionError(messages.subexpressions,json);return new ArrayExpression(json,processors)}return json.hasOwnProperty("dictionary")?new DictionaryExpression(json,processors):void 0}exports.Expression=Expression;var ProcessValueType,ElementExpression=function(){function ElementExpression(json,processors,root){if(void 0===root&&(root=!1),this.root=root,this.subtype="element","object"!=typeof json.element||json.element instanceof Array)throw new ExpressionError(messages.elementType,json);if((json=json.element).hasOwnProperty("required")){if("boolean"!=typeof json.required&&("string"!=typeof json.required||0===json.required.length))throw new ExpressionError(messages.requiredType,json);this.required=json.required}if(json.hasOwnProperty("contains")){if("string"!=typeof json.contains)throw new ExpressionError(messages.containsType,json);this.contains=json.contains}json.hasOwnProperty("within")&&(this.within=new WithinExpression(json)),json.hasOwnProperty("process")&&(this.process=new ProcessExpression(json,processors)),this.subexpression=getSubexpression(json,processors)}return ElementExpression.prototype.extract=function(input){var str=input;if(this.contains&&this.contains.length>0&&str.indexOf(this.contains)<0)return new ExtractionError(this.root?"contains":"element.contains");if(this.within){if(isError(result=this.within.extract(str)))return result.at=(this.root?"within.":"element.within.")+result.at,result;str=result}if(this.process){var result;if(isError(result=this.process.extract(str)))return result.at=(this.root?"process.":"element.process.")+result.at,result;str=result}return this.subexpression?this.subexpression.extract(str):str},ElementExpression.prototype.toJSON=function(){var json={};return void 0!==this.required&&(json.required=this.required),void 0!==this.contains&&(json.contains=this.contains),void 0!==this.within&&(json.within=this.within.toJSON()),void 0!==this.process&&(json.process=this.process.toJSON()),this.subexpression&&(json[this.subexpression.subtype]=this.subexpression.toJSON()),json},ElementExpression}(),ArrayExpression=function(){function ArrayExpression(json,processors){if(this.subtype="array","object"!=typeof json.array||json.array instanceof Array)throw new ExpressionError(messages.arrayType,json);if(!(json=json.array).hasOwnProperty("separator"))throw new ExpressionError(messages.separatorMissing,json);switch(typeof json.separator){case"string":if(0===json.separator.length)throw new ExpressionError(messages.separatorType,json);this.separator=json.separator;break;case"object":json.separator instanceof Array&&(json.separator.forEach(function(separator){if("string"!=typeof separator||0===separator.length)throw new ExpressionError(messages.separatorType,json)}),this.separator=json.separator)}if(void 0===this.separator)throw new ExpressionError(messages.separatorType,json);this.subexpression=getSubexpression(json,processors)}return ArrayExpression.prototype.extract=function(input){for(var parts=[input],separators="string"==typeof this.separator?[this.separator]:this.separator,si=0;si<separators.length;si+=1){for(var groups=[],ii=0;ii<parts.length;ii+=1)groups[ii]=parts[ii].split(separators[si]);parts=[].concat.apply([],groups)}for(var array=[],i=0;i<parts.length;i+=1){var item=parts[i];if(0!==item.length)if(this.subexpression){var result=this.subexpression.extract(item);if(isError(result)){if(void 0===this.subexpression.required||this.subexpression.required)return result.at=this.subtype+"."+result.at,result}else"string"==typeof result?result.length>0&&array.push(result):array.push(result)}else array.push(item)}return array},ArrayExpression.prototype.toJSON=function(){var json={separator:this.separator};return this.subexpression&&(json[this.subexpression.subtype]=this.subexpression.toJSON()),json},ArrayExpression}(),DictionaryExpression=function(){function DictionaryExpression(json,processors){var _this=this;if(this.subtype="dictionary","object"!=typeof json.dictionary||json.dictionary instanceof Array)throw new ExpressionError(messages.dictionaryType,json);json=json.dictionary,this.elements={},Object.keys(json).forEach(function(name){var value=json[name];if("object"!=typeof value||value instanceof Array)throw new ExpressionError(messages.dictionaryValueType.replace("{name}",name),json);_this.elements[name]=new ElementExpression({element:value},processors,!0)})}return DictionaryExpression.prototype.extract=function(input){for(var dictionary={},errors={},names=Object.keys(this.elements),i=0;i<names.length;i+=1){var name_1=names[i],element=this.elements[name_1],result=element.extract(input);if(isError(result)){if(void 0===element.required||element.required){if("string"!=typeof element.required)return result.at=this.subtype+"."+name_1+"."+result.at,result;element.required in errors||(result.at=this.subtype+"."+name_1+"("+element.required+")."+result.at,errors[element.required]=result)}}else"string"==typeof element.required&&(errors[element.required]=void 0),dictionary[name_1]=result}var requireds=Object.keys(errors);for(i=0;i<requireds.length;i+=1){var error=errors[requireds[i]];if(void 0!==error)return error}return dictionary},DictionaryExpression.prototype.toJSON=function(){var _this=this,json={};return Object.keys(this.elements).forEach(function(name){json[name]=_this.elements[name].toJSON()}),json},DictionaryExpression}(),WithinExpression=function(){function WithinExpression(json){if("object"!=typeof json.within||json.within instanceof Array)throw new ExpressionError(messages.withinType,json);if((json=json.within).hasOwnProperty("reversed")){if("boolean"!=typeof json.reversed)throw new ExpressionError(messages.reversedType,json);this.reversed=json.reversed}if(json.hasOwnProperty("prefix")){switch(typeof json.prefix){case"string":this.prefix=json.prefix;break;case"object":json.prefix instanceof Array&&(json.prefix.forEach(function(prefix){if("string"!=typeof prefix)throw new ExpressionError(messages.prefixType,json)}),this.prefix=json.prefix)}if(void 0===this.prefix)throw new ExpressionError(messages.prefixType,json)}if(json.hasOwnProperty("suffix")){switch(typeof json.suffix){case"string":this.suffix=json.suffix;break;case"object":json.suffix instanceof Array&&(json.suffix.forEach(function(suffix){if("string"!=typeof suffix)throw new ExpressionError(messages.suffixType,json)}),this.suffix=json.suffix)}if(void 0===this.suffix)throw new ExpressionError(messages.suffixType,json)}if(json.hasOwnProperty("trimming")){if("boolean"!=typeof json.trimming)throw new ExpressionError(messages.trimmingType,json);this.trimming=json.trimming}}return WithinExpression.prototype.extract=function(input){for(var str=input,prefixes=void 0===this.prefix?[]:"string"==typeof this.prefix?[this.prefix]:this.prefix,i=0;i<prefixes.length;i+=1){var prefix=prefixes[i];if(prefix.length>0)if(this.reversed){if(!((end=str.lastIndexOf(prefix))>=0))return"string"==typeof this.prefix?new ExtractionError("prefix"):new ExtractionError("prefix."+prefix+"("+i+")");str=str.substring(0,end)}else{if(!((start=str.indexOf(prefix))>=0))return"string"==typeof this.prefix?new ExtractionError("prefix"):new ExtractionError("prefix."+prefix+"("+i+")");str=str.substring(start+prefix.length)}}var suffixes=void 0===this.suffix?[]:"string"==typeof this.suffix?[this.suffix]:this.suffix,suffixed=!1,suffixesCount=0;for(i=0;i<suffixes.length;i+=1){var start,end,suffix=suffixes[i];if(suffix.length>0)if(suffixesCount+=1,this.reversed){if((start=str.lastIndexOf(suffix))>=0){str=str.substring(start+this.suffix.length),suffixed=!0;break}}else if((end=str.indexOf(suffix))>=0){str=str.substring(0,end),suffixed=!0;break}}return!suffixed&&suffixesCount>0?new ExtractionError("suffix"):(this.trimming&&(str=str.trim()),str)},WithinExpression.prototype.toJSON=function(){var json={};return void 0!==this.reversed&&(json.reversed=this.reversed),void 0!==this.prefix&&(json.prefix=this.prefix),void 0!==this.suffix&&(json.suffix=this.suffix),void 0!==this.trimming&&(json.trimming=this.trimming),json},WithinExpression}();!function(ProcessValueType){ProcessValueType[ProcessValueType.string=0]="string",ProcessValueType[ProcessValueType.object=1]="object",ProcessValueType[ProcessValueType.array=2]="array"}(ProcessValueType||(ProcessValueType={}));var ProcessExpression=function(){function ProcessExpression(json,processes){var _this=this;this.processors=[];var processValue=json.process;if("string"==typeof processValue){if(this.valueType=ProcessValueType.string,"function"!=typeof(process=processes[processValue]))throw new ExpressionError(messages.processUndefined.replace("{name}",processValue),json);this.processors.push({name:processValue,process:process,valueType:ProcessValueType.string})}else{if("object"!=typeof processValue)throw new ExpressionError(messages.processType,json);if(processValue instanceof Array)this.valueType=ProcessValueType.array,processValue.forEach(function(item){if("string"==typeof item){if("function"!=typeof(process=processes[item]))throw new ExpressionError(messages.processUndefined.replace("{name}",item),json);_this.processors.push({name:item,process:process,valueType:ProcessValueType.string})}else{if("object"!=typeof item||item instanceof Array)throw new ExpressionError(messages.processType,json);if(!item.hasOwnProperty("name"))throw new ExpressionError(messages.processNameMissing,json);if("string"!=typeof item.name)throw new ExpressionError(messages.processNameType,json);var process;if("function"!=typeof(process=processes[item.name]))throw new ExpressionError(messages.processUndefined.replace("{name}",item.name),json);_this.processors.push({name:item.name,process:process,arg:item.arg,valueType:ProcessValueType.object})}});else{if(this.valueType=ProcessValueType.object,!processValue.hasOwnProperty("name"))throw new ExpressionError(messages.processNameMissing,json);if("string"!=typeof processValue.name)throw new ExpressionError(messages.processNameType,json);var process;if("function"!=typeof(process=processes[processValue.name]))throw new ExpressionError(messages.processUndefined.replace("{name}",processValue.name),json);this.processors.push({name:processValue.name,process:process,arg:processValue.arg,valueType:ProcessValueType.object})}}}return ProcessExpression.prototype.extract=function(input){for(var str=input,i=0;i<this.processors.length;i+=1){var processor=this.processors[i];try{str=processor.process(str,processor.arg)}catch(e){var error=new ExtractionError(processor.name+"("+i+")");return e.stack&&(error.stack=e.stack),error}}return str},ProcessExpression.prototype.toJSON=function(){if(this.valueType===ProcessValueType.string)return this.processors[0].name;if(this.valueType===ProcessValueType.object){var json={name:this.processors[0].name};return void 0!==this.processors[0].arg&&(json.arg=this.processors[0].arg),json}var array_1=[];return this.processors.forEach(function(processor){if(processor.valueType===ProcessValueType.string)array_1.push(processor.name);else{var json={name:processor.name};void 0!==processor.arg&&(json.arg=processor.arg),array_1.push(json)}}),array_1},ProcessExpression}()});